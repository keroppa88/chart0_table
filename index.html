<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>日本株データダッシュボード</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:'Segoe UI','Hiragino Kaku Gothic Pro','Yu Gothic',sans-serif;
  background:#dde0e8;
  color:#1a1a2e;
  height:100vh;
  overflow:hidden;
}

/* ===== ヘッダー ===== */
.header{
  background:linear-gradient(135deg,#1a237e 0%,#283593 100%);
  color:#fff;
  padding:0 24px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  position:sticky;top:0;z-index:50;
  box-shadow:0 2px 8px rgba(0,0,0,.25);
  height:52px;
}
.header-left{display:flex;align-items:center;gap:16px}
.header h1{font-size:18px;font-weight:600;letter-spacing:.5px;white-space:nowrap}
.count{font-size:13px;opacity:.85}
.search-box{
  padding:6px 12px;
  border:none;border-radius:6px;
  background:rgba(255,255,255,.15);
  color:#fff;
  font-size:13px;
  width:200px;
  outline:none;
}
.search-box::placeholder{color:rgba(255,255,255,.5)}
.search-box:focus{background:rgba(255,255,255,.25)}

/* ===== ウィンドウコンテナ ===== */
.win-container{
  position:relative;
  height:calc(100vh - 52px);
  overflow:hidden;
  background:#dde0e8;
}

/* ===== フローティングウィンドウ ===== */
.win{
  position:absolute;
  display:flex;
  flex-direction:column;
  border-radius:8px;
  box-shadow:0 6px 24px rgba(0,0,0,.22),0 1px 4px rgba(0,0,0,.12);
  background:#fff;
  min-width:220px;
  min-height:60px;
  border:1px solid rgba(0,0,0,.08);
  z-index:1;
}

.win-titlebar{
  background:linear-gradient(90deg,#303f9f 0%,#3949ab 100%);
  color:#fff;
  padding:0 10px;
  border-radius:8px 8px 0 0;
  display:flex;
  align-items:center;
  cursor:move;
  user-select:none;
  gap:8px;
  flex-shrink:0;
  height:34px;
}
.win.minimized .win-titlebar{border-radius:8px}

.win-title{
  font-size:12px;
  font-weight:600;
  flex:1;
  letter-spacing:.3px;
}

.win-btn-min{
  background:#ffc107;
  color:#5a3e00;
  border:none;
  cursor:pointer;
  width:20px;height:20px;
  border-radius:50%;
  font-size:14px;font-weight:700;
  display:flex;align-items:center;justify-content:center;
  flex-shrink:0;
  padding:0;
  line-height:1;
}
.win-btn-min:hover{background:#ffb300}

.win-body{
  flex:1;
  overflow:hidden;
  min-height:0;
}
.win.minimized .win-body{display:none}

/* リサイズハンドル（全8方向） */
.resize-handle{
  position:absolute;
  z-index:10;
}
/* 上下左右辺 */
.resize-n { top:0; left:12px; right:12px; height:5px; cursor:n-resize; }
.resize-s { bottom:0; left:12px; right:12px; height:5px; cursor:s-resize; }
.resize-e { right:0; top:12px; bottom:12px; width:5px; cursor:e-resize; }
.resize-w { left:0; top:12px; bottom:12px; width:5px; cursor:w-resize; }
/* 四隅 */
.resize-nw { top:0; left:0; width:12px; height:12px; cursor:nw-resize; }
.resize-ne { top:0; right:0; width:12px; height:12px; cursor:ne-resize; }
.resize-sw { bottom:0; left:0; width:12px; height:12px; cursor:sw-resize; }
.resize-se { bottom:0; right:0; width:12px; height:12px; cursor:se-resize; }
/* 四隅の視覚的インジケーター */
.resize-nw::after,.resize-ne::after,.resize-sw::after,.resize-se::after{
  content:'';position:absolute;
  width:7px;height:7px;
  border-color:rgba(0,0,0,.22);border-style:solid;
}
.resize-se::after{bottom:2px;right:2px;border-width:0 2px 2px 0}
.resize-sw::after{bottom:2px;left:2px;border-width:0 0 2px 2px}
.resize-ne::after{top:2px;right:2px;border-width:2px 2px 0 0}
.resize-nw::after{top:2px;left:2px;border-width:2px 0 0 2px}
.win.minimized .resize-handle{display:none}

/* ===== テーブルパネル ===== */
.table-panel{
  width:100%;
  height:100%;
  overflow:auto;
  background:#f0f2f5;
}

/* ===== テーブル ===== */
table{
  width:max-content;
  border-collapse:collapse;
  font-size:13px;
}
thead{position:sticky;top:0;z-index:10}
th{
  background:#303f9f;
  color:#fff;
  padding:10px 8px;
  text-align:right;
  cursor:pointer;
  white-space:normal;
  user-select:none;
  border-right:1px solid rgba(255,255,255,.08);
  font-weight:600;
  font-size:11px;
  letter-spacing:.3px;
  width:90px;
  line-height:1.4;
}
th .th-label{
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
}
th:first-child{text-align:center;width:40px}
th:hover{background:#3949ab}
th[draggable="true"]{cursor:grab}
th[draggable="true"]:active{cursor:grabbing}
th.dragging{opacity:.4}
th.drag-over-left{box-shadow:inset 3px 0 0 #ffeb3b}
th.drag-over-right{box-shadow:inset -3px 0 0 #ffeb3b}
th .sort-icon{font-size:10px;margin-left:3px;opacity:.7}

td{
  padding:7px 8px;
  text-align:right;
  border-bottom:1px solid #e8eaf0;
  cursor:pointer;
  white-space:nowrap;
  transition:background .1s;
}
td:first-child{text-align:center;color:#888;font-size:12px}
td.col-code{text-align:left;font-weight:600;color:#1a237e}
td.col-name{text-align:left;font-size:12px;max-width:140px;overflow:hidden;text-overflow:ellipsis}

/* ===== 左3列 (#, コード, 銘柄名) を固定 ===== */
th:nth-child(1),td:nth-child(1){position:sticky;left:0;z-index:5;background:#303f9f}
th:nth-child(2),td:nth-child(2){position:sticky;left:40px;z-index:5}
th:nth-child(3),td:nth-child(3){position:sticky;left:130px;z-index:5}
td:nth-child(1){background:#f8f9fc}
td:nth-child(2),td:nth-child(3){background:#fff}
tr:nth-child(even) td:nth-child(1),
tr:nth-child(even) td:nth-child(2),
tr:nth-child(even) td:nth-child(3){background:#f0f1f6}
tr:hover td:nth-child(1),
tr:hover td:nth-child(2),
tr:hover td:nth-child(3){background:#e3f2fd}
th:nth-child(2),th:nth-child(3){background:#303f9f}
td:nth-child(3){border-right:2px solid #c5cae9}
td.col-date{text-align:center;font-size:11px;color:#555}

tr:nth-child(even) td{background:#f8f9fc}
tr:hover td{background:#e3f2fd}
td:hover{background:#bbdefb !important}

.negative{color:#d32f2f}

/* ===== グラフパネル ===== */
.graph-panel{
  width:100%;
  height:100%;
  display:flex;
  flex-direction:column;
  background:#eceff1;
  overflow:hidden;
}

.graph-slot{
  flex:1;
  display:flex;
  flex-direction:column;
  border-bottom:1px solid #cfd8dc;
  position:relative;
  transition:background .15s;
  min-height:0;
}
.graph-slot:last-child{border-bottom:none}

.graph-slot.selected{
  background:#e8ffd4;
  box-shadow:inset 0 0 0 2px #66bb6a;
}

/* ===== スロットヘッダー ===== */
.slot-header{
  display:flex;
  align-items:center;
  padding:5px 8px;
  gap:6px;
  background:rgba(255,255,255,.75);
  border-bottom:1px solid #dde;
  cursor:pointer;
  flex-shrink:0;
  min-height:32px;
  user-select:none;
}
.slot-header:hover{background:rgba(255,255,255,.95)}
.graph-slot.selected .slot-header{
  background:rgba(102,187,106,.18);
}

.slot-badge{
  background:#78909c;
  color:#fff;
  border-radius:50%;
  width:20px;height:20px;
  display:flex;align-items:center;justify-content:center;
  font-size:11px;font-weight:700;
  flex-shrink:0;
  transition:background .15s;
}
.graph-slot.selected .slot-badge{background:#43a047}

.slot-label{
  font-size:10px;
  font-weight:700;
  color:#546e7a;
  flex-shrink:0;
  letter-spacing:.3px;
}
.graph-slot.selected .slot-label{color:#2e7d32}

.slot-title{
  font-size:10px;
  color:#90a4ae;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  flex:1;
}
.graph-slot.selected .slot-title{color:#5c6bc0}

.slot-select-hint{
  font-size:9px;
  color:#bbb;
  flex-shrink:0;
  white-space:nowrap;
}
.graph-slot.selected .slot-select-hint{
  color:#7986cb;
  font-weight:600;
}

/* ===== スロットボディ ===== */
.slot-body{
  flex:1;
  position:relative;
  min-height:0;
}

.slot-empty{
  position:absolute;
  inset:0;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  color:#b0bec5;
  font-size:12px;
  line-height:1.9;
  text-align:center;
  pointer-events:none;
}
.graph-slot.selected .slot-empty{color:#7986cb}

.slot-empty-icon{
  font-size:32px;
  margin-bottom:6px;
  opacity:.35;
  line-height:1;
}

.slot-canvas-wrap{
  position:absolute;
  inset:0;
  padding:4px 6px 6px 4px;
  display:none;
}
.slot-canvas-wrap.visible{display:block}

/* ===== ローディング ===== */
.loading{
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  height:calc(100vh - 52px);
  gap:12px;
}
.loading .spinner{
  width:36px;height:36px;
  border:3px solid #e0e0e0;
  border-top-color:#1a237e;
  border-radius:50%;
  animation:spin .8s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
.loading p{font-size:14px;color:#888}
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <h1>日本株データダッシュボード</h1>
    <input type="text" class="search-box" id="searchBox" placeholder="コード・銘柄検索...">
    <span class="count" id="stockCount"></span>
  </div>
</div>

<div class="loading" id="loading">
  <div class="spinner"></div>
  <p>データを読み込み中...</p>
</div>

<div class="win-container" id="winContainer" style="display:none">

  <!-- テーブルウィンドウ -->
  <div class="win" id="tableWin">
    <div class="win-titlebar" id="tableWinBar">
      <span class="win-title">データテーブル</span>
      <button class="win-btn-min" onclick="toggleMinimize('tableWin')">－</button>
    </div>
    <div class="win-body">
      <div class="table-panel" id="tableWrap">
        <table>
          <thead><tr id="headRow"></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
    <div class="resize-handle resize-n"  data-dir="n"></div>
    <div class="resize-handle resize-s"  data-dir="s"></div>
    <div class="resize-handle resize-e"  data-dir="e"></div>
    <div class="resize-handle resize-w"  data-dir="w"></div>
    <div class="resize-handle resize-nw" data-dir="nw"></div>
    <div class="resize-handle resize-ne" data-dir="ne"></div>
    <div class="resize-handle resize-sw" data-dir="sw"></div>
    <div class="resize-handle resize-se" data-dir="se"></div>
  </div>

  <!-- グラフウィンドウ -->
  <div class="win" id="graphWin">
    <div class="win-titlebar" id="graphWinBar">
      <span class="win-title">グラフ</span>
      <button class="win-btn-min" onclick="toggleMinimize('graphWin')">－</button>
    </div>
    <div class="win-body">
      <div class="graph-panel" id="graphPanel">

        <!-- スロット 1 -->
        <div class="graph-slot selected" id="slot0">
          <div class="slot-header" onclick="selectSlot(0)">
            <div class="slot-badge">1</div>
            <span class="slot-label">グラフ1</span>
            <span class="slot-title" id="slotTitle0">-</span>
            <span class="slot-select-hint" id="slotHint0">選択中</span>
          </div>
          <div class="slot-body">
            <div class="slot-empty" id="slotEmpty0">
              <div class="slot-empty-icon">&#9646;</div>
              選択中<br>表をクリックして表示
            </div>
            <div class="slot-canvas-wrap" id="slotCanvasWrap0">
              <canvas id="chartCanvas0"></canvas>
            </div>
          </div>
        </div>

        <!-- スロット 2 -->
        <div class="graph-slot" id="slot1">
          <div class="slot-header" onclick="selectSlot(1)">
            <div class="slot-badge">2</div>
            <span class="slot-label">グラフ2</span>
            <span class="slot-title" id="slotTitle1">-</span>
            <span class="slot-select-hint" id="slotHint1">クリックして選択</span>
          </div>
          <div class="slot-body">
            <div class="slot-empty" id="slotEmpty1">
              <div class="slot-empty-icon">&#9646;</div>
              クリックして選択
            </div>
            <div class="slot-canvas-wrap" id="slotCanvasWrap1">
              <canvas id="chartCanvas1"></canvas>
            </div>
          </div>
        </div>

        <!-- スロット 3 -->
        <div class="graph-slot" id="slot2">
          <div class="slot-header" onclick="selectSlot(2)">
            <div class="slot-badge">3</div>
            <span class="slot-label">グラフ3</span>
            <span class="slot-title" id="slotTitle2">-</span>
            <span class="slot-select-hint" id="slotHint2">クリックして選択</span>
          </div>
          <div class="slot-body">
            <div class="slot-empty" id="slotEmpty2">
              <div class="slot-empty-icon">&#9646;</div>
              クリックして選択
            </div>
            <div class="slot-canvas-wrap" id="slotCanvasWrap2">
              <canvas id="chartCanvas2"></canvas>
            </div>
          </div>
        </div>

      </div><!-- /graph-panel -->
    </div><!-- /win-body -->
    <div class="resize-handle resize-n"  data-dir="n"></div>
    <div class="resize-handle resize-s"  data-dir="s"></div>
    <div class="resize-handle resize-e"  data-dir="e"></div>
    <div class="resize-handle resize-w"  data-dir="w"></div>
    <div class="resize-handle resize-nw" data-dir="nw"></div>
    <div class="resize-handle resize-ne" data-dir="ne"></div>
    <div class="resize-handle resize-sw" data-dir="sw"></div>
    <div class="resize-handle resize-se" data-dir="se"></div>
  </div><!-- /graphWin -->

</div><!-- /win-container -->

<script>
/* ============================================================
   データ定義
   ============================================================ */
const COLS = [
  {key:'rank',    label:'#',                      sortable:false, chart:false, type:'rank'},
  {key:'code',    label:'銘柄コード',              sortable:true,  chart:false, type:'code'},
  {key:'name',    label:'銘柄名',                  sortable:true,  chart:false, type:'name'},
  {key:'price',   label:'株価',                    sortable:true,  chart:true,  color:'#1565c0', unit:'円', type:'price',    lineChart:true},
  {key:'CurFYEn', label:'当事業年度終了日',         sortable:true,  chart:false, type:'date'},
  {key:'DiscDate',label:'開示日',                  sortable:true,  chart:false, type:'date'},
  {key:'NxtFYEn', label:'翌事業年度終了日',         sortable:true,  chart:false, type:'date'},
  {key:'Sales',   label:'売上高（当該年度・現時点）',          sortable:true,  chart:true,  color:'#1565c0', unit:'円', type:'bignum', quarterly:true, chartLabel:'四半期売上高（実績）'},
  {key:'OP',      label:'営業利益（当該年度・現時点）',        sortable:true,  chart:true,  color:'#2e7d32', unit:'円', type:'bignum', quarterly:true, chartLabel:'四半期営業利益（実績）'},
  {key:'OdP',     label:'経常利益（当該年度・現時点）',        sortable:true,  chart:true,  color:'#2e7d32', unit:'円', type:'bignum', quarterly:true, chartLabel:'四半期経常利益（実績）'},
  {key:'NP',      label:'当期純利益（当該年度・現時点）',      sortable:true,  chart:true,  color:'#2e7d32', unit:'百万円', type:'bignum', quarterly:true, chartLabel:'四半期当期純利益（実績）'},
  {key:'EPS',     label:'一株当たり当期純利益（当該年度・現時点）', sortable:true, chart:true, color:'#6a1b9a', unit:'円', type:'decimal', quarterly:true, chartLabel:'四半期一株当たり当期純利益（実績）'},
  {key:'DEPS',    label:'潜在株式調整後EPS',        sortable:true,  chart:true,  color:'#6a1b9a', unit:'円', type:'decimal'},
  {key:'TA',      label:'総資産',                  sortable:true,  chart:true,  color:'#e65100', unit:'円', type:'bignum'},
  {key:'Eq',      label:'純資産',                  sortable:true,  chart:true,  color:'#e65100', unit:'円', type:'bignum'},
  {key:'EqAR',    label:'自己資本比率',             sortable:true,  chart:true,  color:'#00838f', unit:'%', type:'percent'},
  {key:'BPS',     label:'一株あたり純資産',         sortable:true,  chart:true,  color:'#e65100', unit:'円', type:'decimal'},
  {key:'CFO',     label:'営業CF',                  sortable:true,  chart:true,  color:'#4527a0', unit:'円', type:'bignum'},
  {key:'CFI',     label:'投資CF',                  sortable:true,  chart:true,  color:'#4527a0', unit:'円', type:'bignum'},
  {key:'CFF',     label:'財務CF',                  sortable:true,  chart:true,  color:'#4527a0', unit:'円', type:'bignum'},
  {key:'CFTotal', label:'キャッシュフロー',         sortable:true,  chart:true,  color:'#283593', unit:'円', type:'bignum'},
  {key:'CashEq',  label:'現金同等物',              sortable:true,  chart:true,  color:'#4527a0', unit:'円', type:'bignum'},
  {key:'DivAnn',  label:'配当実績',                sortable:true,  chart:true,  color:'#c62828', unit:'円', type:'decimal'},
  {key:'FDivAnn', label:'配当予想',                sortable:true,  chart:true,  color:'#c62828', unit:'円', type:'decimal'},
  {key:'FPayoutRatioAnn', label:'予想配当性向',     sortable:true,  chart:true,  color:'#c62828', unit:'%', type:'percent'},
  {key:'FSales',  label:'売上高予想',              sortable:true,  chart:true,  color:'#1565c0', unit:'円', type:'bignum'},
  {key:'FOP',     label:'営業利益予想',            sortable:true,  chart:true,  color:'#2e7d32', unit:'円', type:'bignum'},
  {key:'FOdP',    label:'経常利益予想',            sortable:true,  chart:true,  color:'#2e7d32', unit:'円', type:'bignum'},
  {key:'FNP',     label:'純利益予想',              sortable:true,  chart:true,  color:'#2e7d32', unit:'円', type:'bignum'},
  {key:'FEPS',    label:'EPS予想',                 sortable:true,  chart:true,  color:'#6a1b9a', unit:'円', type:'decimal'},
  {key:'NxFSales',label:'売上高予想(翌)',           sortable:true,  chart:true,  color:'#1565c0', unit:'円', type:'bignum'},
  {key:'NxFOP',   label:'営業利益予想(翌)',         sortable:true,  chart:true,  color:'#2e7d32', unit:'円', type:'bignum'},
  {key:'NxFOdP',  label:'経常利益予想(翌)',         sortable:true,  chart:true,  color:'#2e7d32', unit:'円', type:'bignum'},
  {key:'NxFNp',   label:'純利益予想(翌)',           sortable:true,  chart:true,  color:'#2e7d32', unit:'円', type:'bignum'},
  {key:'NxFEPS',  label:'EPS予想(翌)',             sortable:true,  chart:true,  color:'#6a1b9a', unit:'円', type:'decimal'},
  {key:'DivYield',label:'配当利回り',               sortable:true,  chart:true,  color:'#c62828', unit:'%', type:'decimal',  lineChart:true},
  {key:'FDivYield',label:'予想配当利回り',          sortable:true,  chart:true,  color:'#c62828', unit:'%', type:'decimal',  lineChart:true},
  {key:'MarketCap',label:'時価総額',               sortable:true,  chart:true,  color:'#1565c0', unit:'円', type:'bignum',   lineChart:true},
  {key:'per',     label:'PER',                    sortable:true,  chart:true,  color:'#6a1b9a', unit:'倍', type:'decimal',  lineChart:true},
  {key:'fper',    label:'予想PER',                 sortable:true,  chart:true,  color:'#6a1b9a', unit:'倍', type:'decimal',  lineChart:true},
  {key:'pbr',     label:'PBR',                    sortable:true,  chart:true,  color:'#e65100', unit:'倍', type:'decimal',  lineChart:true},
  {key:'psr',     label:'PSR',                    sortable:true,  chart:true,  color:'#e65100', unit:'倍', type:'decimal',  lineChart:true},
  {key:'roe',     label:'ROE',                    sortable:true,  chart:true,  color:'#00838f', unit:'%', type:'decimal'},
  {key:'roa',     label:'ROA',                    sortable:true,  chart:true,  color:'#00838f', unit:'%', type:'decimal'},
  {key:'ev_ebitda',label:'EV/EBITDA',              sortable:true,  chart:true,  color:'#4527a0', unit:'倍', type:'decimal',  lineChart:true},
  {key:'pcfr',    label:'PCFR',                   sortable:true,  chart:true,  color:'#4527a0', unit:'倍', type:'decimal',  lineChart:true},
];

// financeHistory index mapping
const FH = {
  NP:1, per:2, pbr:3, roe:4, pcfr:5, Sales:6, OP:7, OdP:8, EPS:9, BPS:10, CFO:11, CashEq:12, MarketCap:13, CurFYEn:14,
  TA:15, Eq:16, EqAR:17, CFI:18, CFF:19, DivAnn:20, DEPS:21, roa:22, DivYield:23, fper:24, psr:25, ev_ebitda:26,
  FDivAnn:27, FPayoutRatioAnn:28, FSales:29, FOP:30, FOdP:31, FNP:32, FEPS:33,
  NxFSales:34, NxFOP:35, NxFOdP:36, NxFNp:37, NxFEPS:38, FDivYield:39, CFTotal:40,
};

let allStocks = [];
let viewStocks = [];
let sortKey = null;
let sortAsc = true;
let dragSrcIdx = null;

// グラフスロット管理
let selectedSlot = 0;
const chartInstances = [null, null, null];

// ウィンドウ管理
let zTop = 10;
let activeDrag = null;
let activeResize = null;
const winSavedSizes = {};

/* ============================================================
   初期化
   ============================================================ */
document.addEventListener('DOMContentLoaded', init);

async function init() {
  buildHeader();

  try {
    const res = await fetch('stock_data.json');
    allStocks = await res.json();
  } catch (e) {
    document.getElementById('loading').innerHTML =
      '<p style="color:#c00">stock_data.json の読み込みに失敗しました。<br>python3 build_data.py を実行してデータを生成してください。<br>また python3 -m http.server でサーバーを起動してアクセスしてください。</p>';
    return;
  }

  viewStocks = allStocks.slice();
  sortBy('code', true);

  document.getElementById('loading').style.display = 'none';
  const container = document.getElementById('winContainer');
  container.style.display = 'block';
  initWindows();
  updateCount();

  // 検索
  document.getElementById('searchBox').addEventListener('input', onSearch);

  // 矢印キーでテーブルスクロール
  const scrollStep = 100;
  document.addEventListener('keydown', e => {
    if (document.activeElement === document.getElementById('searchBox')) return;
    const wrap = document.getElementById('tableWrap');
    switch (e.key) {
      case 'ArrowRight': wrap.scrollLeft += scrollStep; e.preventDefault(); break;
      case 'ArrowLeft':  wrap.scrollLeft -= scrollStep; e.preventDefault(); break;
      case 'ArrowDown':  wrap.scrollTop  += scrollStep; e.preventDefault(); break;
      case 'ArrowUp':    wrap.scrollTop  -= scrollStep; e.preventDefault(); break;
    }
  });

  // winContainer の背景クリックでグラフスロット選択解除
  document.getElementById('winContainer').addEventListener('click', e => {
    if (e.target === document.getElementById('winContainer')) deselectSlot();
  });

  // ヘッダーの何もない場所クリックでグラフスロット選択解除
  document.querySelector('.header').addEventListener('click', e => {
    if (!e.target.closest('input, button, a, select')) deselectSlot();
  });

  // グローバルマウスイベント（ドラッグ・リサイズ）
  document.addEventListener('mousemove', e => {
    if (activeDrag) {
      const dx = e.clientX - activeDrag.startX;
      const dy = e.clientY - activeDrag.startY;
      activeDrag.win.style.left = (activeDrag.startLeft + dx) + 'px';
      activeDrag.win.style.top  = Math.max(0, activeDrag.startTop  + dy) + 'px';
    }
    if (activeResize) {
      const dx = e.clientX - activeResize.startX;
      const dy = e.clientY - activeResize.startY;
      const dir = activeResize.dir;
      const w = activeResize.win;
      // 右辺・右角
      if (dir.includes('e')) {
        w.style.width = Math.max(220, activeResize.startW + dx) + 'px';
      }
      // 下辺・下角
      if (dir.includes('s')) {
        w.style.height = Math.max(60, activeResize.startH + dy) + 'px';
      }
      // 左辺・左角（位置も同時調整）
      if (dir.includes('w')) {
        const newW = Math.max(220, activeResize.startW - dx);
        w.style.width = newW + 'px';
        w.style.left = (activeResize.startLeft + activeResize.startW - newW) + 'px';
      }
      // 上辺・上角（位置も同時調整）
      if (dir.includes('n')) {
        let newH = Math.max(60, activeResize.startH - dy);
        let newTop = activeResize.startTop + activeResize.startH - newH;
        if (newTop < 0) {
          newH = Math.max(60, newH + newTop);
          newTop = 0;
        }
        w.style.height = newH + 'px';
        w.style.top = newTop + 'px';
      }
    }
  });

  document.addEventListener('mouseup', () => {
    activeDrag = null;
    activeResize = null;
  });
}

/* ============================================================
   ウィンドウ初期配置・初期化
   ============================================================ */
function initWindows() {
  const container = document.getElementById('winContainer');
  const W = container.offsetWidth;
  const H = container.offsetHeight;
  const gap = 8;
  const tableW = Math.floor((W - 3 * gap) * 0.74);
  const graphW = W - 3 * gap - tableW;
  const winH = H - 2 * gap;

  const tableWin = document.getElementById('tableWin');
  tableWin.style.left   = gap + 'px';
  tableWin.style.top    = gap + 'px';
  tableWin.style.width  = tableW + 'px';
  tableWin.style.height = winH + 'px';

  const graphWin = document.getElementById('graphWin');
  graphWin.style.left   = (gap * 2 + tableW) + 'px';
  graphWin.style.top    = gap + 'px';
  graphWin.style.width  = graphW + 'px';
  graphWin.style.height = winH + 'px';

  ['tableWin', 'graphWin'].forEach(initWin);
}

function initWin(id) {
  const win = document.getElementById(id);
  const titlebar = win.querySelector('.win-titlebar');

  // クリックで前面へ
  win.addEventListener('mousedown', () => {
    win.style.zIndex = ++zTop;
  });

  // タイトルバードラッグ
  titlebar.addEventListener('mousedown', e => {
    if (e.target.classList.contains('win-btn-min')) return;
    e.preventDefault();
    activeDrag = {
      win,
      startX: e.clientX,
      startY: e.clientY,
      startLeft: parseInt(win.style.left) || 0,
      startTop:  parseInt(win.style.top)  || 0,
    };
    win.style.zIndex = ++zTop;
  });

  // 全方向リサイズハンドル
  win.querySelectorAll('.resize-handle').forEach(handle => {
    handle.addEventListener('mousedown', e => {
      e.preventDefault();
      e.stopPropagation();
      activeResize = {
        win,
        dir: handle.dataset.dir,
        startX: e.clientX,
        startY: e.clientY,
        startW: win.offsetWidth,
        startH: win.offsetHeight,
        startLeft: parseInt(win.style.left) || 0,
        startTop:  parseInt(win.style.top)  || 0,
      };
      win.style.zIndex = ++zTop;
    });
  });
}

/* ============================================================
   最小化・復元
   ============================================================ */
function toggleMinimize(id) {
  const win = document.getElementById(id);
  const btn = win.querySelector('.win-btn-min');
  if (win.classList.contains('minimized')) {
    win.classList.remove('minimized');
    if (winSavedSizes[id]) {
      win.style.width  = winSavedSizes[id].w;
      win.style.height = winSavedSizes[id].h;
    }
    btn.textContent = '－';
  } else {
    winSavedSizes[id] = { w: win.style.width, h: win.style.height };
    win.classList.add('minimized');
    win.style.height = '34px';
    btn.textContent = '＋';
  }
}

/* ============================================================
   グラフスロット選択
   ============================================================ */
function selectSlot(slotIdx) {
  selectedSlot = slotIdx;
  for (let i = 0; i < 3; i++) {
    const slot = document.getElementById('slot' + i);
    const hint = document.getElementById('slotHint' + i);
    const empty = document.getElementById('slotEmpty' + i);
    const isSelected = (i === slotIdx);
    slot.classList.toggle('selected', isSelected);
    hint.textContent = isSelected ? '選択中' : 'クリックして選択';
    // チャートがない場合は空表示を更新
    if (!chartInstances[i]) {
      empty.innerHTML = isSelected
        ? '<div class="slot-empty-icon">&#9646;</div>選択中<br>表をクリックして表示'
        : '<div class="slot-empty-icon">&#9646;</div>クリックして選択';
    }
  }
}

function deselectSlot() {
  selectedSlot = -1;
  for (let i = 0; i < 3; i++) {
    const slot = document.getElementById('slot' + i);
    const hint = document.getElementById('slotHint' + i);
    const empty = document.getElementById('slotEmpty' + i);
    slot.classList.remove('selected');
    hint.textContent = 'クリックして選択';
    if (!chartInstances[i]) {
      empty.innerHTML = '<div class="slot-empty-icon">&#9646;</div>クリックして選択';
    }
  }
}

/* ============================================================
   グラフスロットに表示
   ============================================================ */
function showChartInSlot(stock, colKey) {
  // スロット未選択時はスロット0を自動選択
  if (selectedSlot === -1) selectSlot(0);

  // chart:false 列は price にフォールバック
  const colDef = COLS.find(c => c.key === colKey && c.chart) || COLS.find(c => c.key === 'price');
  if (!colDef) return;
  const effectiveKey = colDef.key;

  let labels, values, unit, title;
  unit = colDef.unit;

  if (colDef.quarterly) {
    title = stock.code + ' ' + (stock.name || '') + ' / ' + colDef.chartLabel;
    const result = computeQuarterlyData(stock, effectiveKey);
    labels = result.labels;
    values = result.values;
    if (['NP','Sales','OP','OdP'].includes(effectiveKey)) unit = '億円';
  } else if (effectiveKey === 'price') {
    title = stock.code + ' ' + (stock.name || '') + ' / ' + colDef.label;
    const ph = stock.ph || [];
    labels = ph.map(p => p[0]);
    values = ph.map(p => p[1]);
  } else {
    title = stock.code + ' ' + (stock.name || '') + ' / ' + colDef.label;
    const fh = stock.fh || [];
    const idx = FH[effectiveKey];
    if (idx == null) return;
    const filtered = fh.filter(row => row[idx] != null);
    labels = filtered.map(row => row[0]);

    const bignumKeys = ['NP','Sales','OP','OdP','TA','Eq','CFI','CFF','CFTotal','CashEq','CFO','MarketCap',
                        'FSales','FOP','FOdP','FNP','NxFSales','NxFOP','NxFOdP','NxFNp'];
    if (bignumKeys.includes(effectiveKey)) {
      values = filtered.map(row => Math.round(row[idx] / 10000000) / 10);
      unit = '億円';
    } else if (colDef.type === 'percent') {
      values = filtered.map(row => Math.round(row[idx] * 10000) / 100);
      unit = '%';
    } else {
      values = filtered.map(row => row[idx]);
    }
  }

  if (!labels || !labels.length) return;

  const slotIdx = selectedSlot;

  // 既存チャート破棄
  if (chartInstances[slotIdx]) {
    chartInstances[slotIdx].destroy();
    chartInstances[slotIdx] = null;
  }

  // タイトル更新
  document.getElementById('slotTitle' + slotIdx).textContent = title;

  // 空表示を隠し、キャンバスを表示
  document.getElementById('slotEmpty' + slotIdx).style.display = 'none';
  const canvasWrap = document.getElementById('slotCanvasWrap' + slotIdx);
  canvasWrap.classList.add('visible');

  const canvas = document.getElementById('chartCanvas' + slotIdx);
  const ctx = canvas.getContext('2d');

  const commonOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {display: false},
      tooltip: {
        callbacks: {
          label: c => (colDef.chartLabel || colDef.label) + ': ' + formatNum(c.parsed.y) + ' ' + unit
        }
      }
    },
    scales: {
      x: {
        ticks: {
          maxRotation: 60,
          autoSkip: true,
          maxTicksLimit: 20,
          font: {size: 9}
        },
        grid: {display: false}
      },
      y: {
        ticks: {
          callback: v => formatCompact(v),
          font: {size: 10}
        },
        grid: {color: 'rgba(0,0,0,.06)'}
      }
    },
    animation: {duration: 300}
  };

  if (colDef.lineChart) {
    // 折れ線グラフ（株価・PER・PBR等 株価を使う指標）
    chartInstances[slotIdx] = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: colDef.chartLabel || colDef.label,
          data: values,
          borderColor: colDef.color,
          backgroundColor: hexToRGBA(colDef.color, 0.08),
          borderWidth: 2,
          pointRadius: 2,
          pointHoverRadius: 4,
          fill: true,
          tension: 0.1,
        }]
      },
      options: commonOptions
    });
  } else {
    // 棒グラフ（売上・利益等）
    const bgColors = values.map(v =>
      v < 0 ? 'rgba(211,47,47,0.7)' : hexToRGBA(colDef.color, 0.7)
    );
    const borderColors = values.map(v =>
      v < 0 ? 'rgba(211,47,47,1)' : colDef.color
    );
    chartInstances[slotIdx] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: colDef.chartLabel || colDef.label,
          data: values,
          backgroundColor: bgColors,
          borderColor: borderColors,
          borderWidth: 1,
          borderRadius: 2,
        }]
      },
      options: commonOptions
    });
  }
}

/* ============================================================
   ヘッダー構築
   ============================================================ */
function buildHeader() {
  const tr = document.getElementById('headRow');
  tr.innerHTML = '';
  COLS.forEach((col, i) => {
    const th = document.createElement('th');
    th.title = col.label;
    const labelSpan = document.createElement('span');
    labelSpan.className = 'th-label';
    labelSpan.textContent = col.label;
    th.appendChild(labelSpan);
    if (col.type === 'code' || col.type === 'name') th.style.textAlign = 'left';
    if (col.sortable) {
      th.dataset.key = col.key;
      th.addEventListener('click', () => onHeaderClick(col.key));
      const span = document.createElement('span');
      span.className = 'sort-icon';
      span.id = 'sort-' + col.key;
      th.appendChild(span);
    }
    if (i >= 3) {
      th.draggable = true;
      th.addEventListener('dragstart', e => {
        dragSrcIdx = COLS.indexOf(col);
        th.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
      });
      th.addEventListener('dragend', () => {
        th.classList.remove('dragging');
        tr.querySelectorAll('th').forEach(el => el.classList.remove('drag-over-left', 'drag-over-right'));
        dragSrcIdx = null;
      });
      th.addEventListener('dragover', e => {
        if (dragSrcIdx === null) return;
        const targetIdx = COLS.indexOf(col);
        if (targetIdx < 3 || targetIdx === dragSrcIdx) return;
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        tr.querySelectorAll('th').forEach(el => el.classList.remove('drag-over-left', 'drag-over-right'));
        if (dragSrcIdx < targetIdx) th.classList.add('drag-over-right');
        else th.classList.add('drag-over-left');
      });
      th.addEventListener('dragleave', () => {
        th.classList.remove('drag-over-left', 'drag-over-right');
      });
      th.addEventListener('drop', e => {
        e.preventDefault();
        const targetIdx = COLS.indexOf(col);
        if (targetIdx < 3 || dragSrcIdx === null || dragSrcIdx === targetIdx) return;
        const [moved] = COLS.splice(dragSrcIdx, 1);
        COLS.splice(targetIdx, 0, moved);
        buildHeader();
        updateSortIcons();
        renderTable();
      });
    }
    tr.appendChild(th);
  });
}

/* ============================================================
   テーブル描画
   ============================================================ */
function renderTable() {
  const tbody = document.getElementById('tbody');
  const fragment = document.createDocumentFragment();

  viewStocks.forEach((s, i) => {
    const tr = document.createElement('tr');

    COLS.forEach(col => {
      const td = document.createElement('td');
      const val = s[col.key];

      switch (col.type) {
        case 'rank':
          td.textContent = i + 1;
          break;
        case 'code':
          td.textContent = s.code;
          td.className = 'col-code';
          break;
        case 'name':
          td.textContent = s.name || s.code;
          td.className = 'col-name';
          td.title = s.name || s.code;
          break;
        case 'price':
          td.textContent = val != null ? formatNum(val) : '-';
          break;
        case 'date':
          td.textContent = val || '-';
          td.className = 'col-date';
          break;
        case 'bignum':
          if (val != null) {
            td.textContent = formatBigNum(val);
            if (val < 0) td.className = 'negative';
          } else {
            td.textContent = '-';
          }
          break;
        case 'percent':
          if (val != null) {
            td.textContent = formatDec(val * 100) + '%';
            if (val < 0) td.className = 'negative';
          } else {
            td.textContent = '-';
          }
          break;
        case 'decimal':
        default:
          if (val != null) {
            td.textContent = formatDec(val);
            if (val < 0) td.className = 'negative';
          } else {
            td.textContent = '-';
          }
          break;
      }

      // 全セルクリックでグラフスロットに表示
      // chart:false 列は price にフォールバック
      td.addEventListener('click', () => showChartInSlot(s, col.key));

      tr.appendChild(td);
    });

    fragment.appendChild(tr);
  });

  tbody.innerHTML = '';
  tbody.appendChild(fragment);
}

/* ============================================================
   ソート
   ============================================================ */
function onHeaderClick(key) {
  if (sortKey === key) {
    sortAsc = !sortAsc;
  } else {
    sortAsc = (key === 'code' || key === 'name');
  }
  sortBy(key, sortAsc);
}

function sortBy(key, asc) {
  sortKey = key;
  sortAsc = asc;

  viewStocks.sort((a, b) => {
    let va = a[key];
    let vb = b[key];
    if (va == null && vb == null) return 0;
    if (va == null) return 1;
    if (vb == null) return -1;
    if (typeof va === 'string') {
      return asc ? va.localeCompare(vb) : vb.localeCompare(va);
    }
    return asc ? va - vb : vb - va;
  });

  updateSortIcons();
  renderTable();
}

function updateSortIcons() {
  COLS.forEach(col => {
    if (!col.sortable) return;
    const el = document.getElementById('sort-' + col.key);
    if (col.key === sortKey) {
      el.textContent = sortAsc ? ' \u25B2' : ' \u25BC';
    } else {
      el.textContent = '';
    }
  });
}

/* ============================================================
   検索フィルタ
   ============================================================ */
function onSearch() {
  const q = document.getElementById('searchBox').value.trim().toLowerCase();
  if (!q) {
    viewStocks = allStocks.slice();
  } else {
    viewStocks = allStocks.filter(s =>
      s.code.toLowerCase().includes(q) || (s.name && s.name.toLowerCase().includes(q))
    );
  }
  if (sortKey) sortBy(sortKey, sortAsc);
  else renderTable();
  updateCount();
}

function updateCount() {
  document.getElementById('stockCount').textContent =
    viewStocks.length + ' / ' + allStocks.length + ' 銘柄';
}

/* ============================================================
   四半期データ変換（累積値→四半期ごと）
   ============================================================ */
function computeQuarterlyData(stock, colKey) {
  const fh = stock.fh || [];
  const idx = FH[colKey];
  const fyIdx = FH.CurFYEn;

  const fyGroups = {};
  for (const row of fh) {
    const fy = row[fyIdx];
    const val = row[idx];
    if (!fy || val == null) continue;
    if (!fyGroups[fy]) fyGroups[fy] = [];
    fyGroups[fy].push({date: row[0], value: val});
  }

  const labels = [];
  const values = [];
  const sortedFYs = Object.keys(fyGroups).sort();

  for (const fy of sortedFYs) {
    const entries = fyGroups[fy];
    entries.sort((a, b) => a.date.localeCompare(b.date));

    const fyYear = fy.substring(0, 4);
    const fyMonth = parseInt(fy.substring(5, 7));
    const startYear = fyMonth <= 3 ? parseInt(fyYear) - 1 : parseInt(fyYear);
    if (startYear === 2020) continue;

    let prevCumulative = 0;
    const maxQ = Math.min(entries.length, 4);
    for (let i = 0; i < maxQ; i++) {
      const qNum = i + 1;
      const qValue = entries[i].value - prevCumulative;
      prevCumulative = entries[i].value;
      labels.push(startYear + 'Q' + qNum);
      if (colKey === 'EPS') {
        values.push(Math.round(qValue * 100) / 100);
      } else {
        values.push(Math.round(qValue / 10000000) / 10);
      }
    }
  }

  return {labels, values};
}

/* ============================================================
   ユーティリティ
   ============================================================ */
function formatNum(n) {
  if (n == null) return '-';
  return Number(n).toLocaleString('ja-JP');
}

function formatDec(n) {
  if (n == null) return '-';
  return Number(n).toLocaleString('ja-JP', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
}

function formatBigNum(n) {
  if (n == null) return '-';
  const oku = n / 100000000;
  if (Math.abs(oku) >= 1) {
    return oku.toLocaleString('ja-JP', {
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }) + '億';
  }
  const hyakuman = n / 1000000;
  if (Math.abs(hyakuman) >= 1) {
    return hyakuman.toLocaleString('ja-JP', {
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }) + '百万';
  }
  return formatNum(n);
}

function formatCompact(n) {
  if (Math.abs(n) >= 1e8) return (n / 1e8).toFixed(1) + '億';
  if (Math.abs(n) >= 1e4) return (n / 1e4).toFixed(1) + '万';
  return n.toLocaleString('ja-JP');
}

function hexToRGBA(hex, alpha) {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  return 'rgba(' + r + ',' + g + ',' + b + ',' + alpha + ')';
}
</script>
</body>
</html>
