<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>日本株データダッシュボード</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:'Segoe UI','Hiragino Kaku Gothic Pro','Yu Gothic',sans-serif;
  background:#f0f2f5;
  color:#1a1a2e;
}

/* ===== ヘッダー ===== */
.header{
  background:linear-gradient(135deg,#1a237e 0%,#283593 100%);
  color:#fff;
  padding:14px 24px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  position:sticky;top:0;z-index:50;
  box-shadow:0 2px 8px rgba(0,0,0,.25);
}
.header h1{font-size:18px;font-weight:600;letter-spacing:.5px}
.header-right{display:flex;align-items:center;gap:16px;font-size:13px}
.header-right .count{opacity:.85}
.search-box{
  padding:6px 12px;
  border:none;border-radius:6px;
  background:rgba(255,255,255,.15);
  color:#fff;
  font-size:13px;
  width:200px;
  outline:none;
}
.search-box::placeholder{color:rgba(255,255,255,.5)}
.search-box:focus{background:rgba(255,255,255,.25)}

/* ===== テーブル ===== */
.table-wrap{
  overflow:auto;
  max-height:calc(100vh - 52px);
}
table{
  width:max-content;
  border-collapse:collapse;
  font-size:13px;
}

thead{position:sticky;top:0;z-index:10}
th{
  background:#303f9f;
  color:#fff;
  padding:10px 8px;
  text-align:right;
  cursor:pointer;
  white-space:normal;
  user-select:none;
  border-right:1px solid rgba(255,255,255,.08);
  font-weight:600;
  font-size:11px;
  letter-spacing:.3px;
  min-width:70px;
  line-height:1.4;
}
th:first-child{text-align:center;min-width:40px}
th:hover{background:#3949ab}
th .sort-icon{font-size:10px;margin-left:3px;opacity:.7}

td{
  padding:7px 8px;
  text-align:right;
  border-bottom:1px solid #e8eaf0;
  cursor:pointer;
  white-space:nowrap;
  transition:background .1s;
}
td:first-child{text-align:center;color:#888;font-size:12px}
td.col-code{text-align:left;font-weight:600;color:#1a237e}
td.col-name{text-align:left;font-size:12px;max-width:140px;overflow:hidden;text-overflow:ellipsis}

/* ===== 左3列 (#, コード, 銘柄名) を固定 ===== */
th:nth-child(1),td:nth-child(1){position:sticky;left:0;z-index:5;background:#303f9f}
th:nth-child(2),td:nth-child(2){position:sticky;left:40px;z-index:5}
th:nth-child(3),td:nth-child(3){position:sticky;left:120px;z-index:5}
td:nth-child(1){background:#f8f9fc}
td:nth-child(2),td:nth-child(3){background:#fff}
tr:nth-child(even) td:nth-child(1),
tr:nth-child(even) td:nth-child(2),
tr:nth-child(even) td:nth-child(3){background:#f0f1f6}
tr:hover td:nth-child(1),
tr:hover td:nth-child(2),
tr:hover td:nth-child(3){background:#e3f2fd}
th:nth-child(2),th:nth-child(3){background:#303f9f}
td:nth-child(3){border-right:2px solid #c5cae9}
td.col-date{text-align:center;font-size:11px;color:#555}

tr:nth-child(even) td{background:#f8f9fc}
tr:hover td{background:#e3f2fd}
td:hover{background:#bbdefb !important}

.negative{color:#d32f2f}

/* ===== モーダル ===== */
.overlay{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  z-index:200;
  justify-content:center;
  align-items:center;
  backdrop-filter:blur(2px);
}
.overlay.active{display:flex}

.modal{
  background:#fff;
  border-radius:14px;
  padding:24px 28px;
  width:92vw;max-width:860px;
  max-height:92vh;overflow:auto;
  box-shadow:0 24px 64px rgba(0,0,0,.3);
}
.modal-head{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:16px;
}
.modal-head h2{font-size:16px;color:#1a237e}
.modal-head .sub{font-size:13px;color:#666;margin-left:12px;font-weight:400}
.btn-close{
  background:none;border:none;
  font-size:26px;cursor:pointer;
  color:#999;line-height:1;
  padding:0 4px;
}
.btn-close:hover{color:#333}

.chart-box{position:relative;height:400px}

/* ===== ローディング ===== */
.loading{
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  height:80vh;
  gap:12px;
}
.loading .spinner{
  width:36px;height:36px;
  border:3px solid #e0e0e0;
  border-top-color:#1a237e;
  border-radius:50%;
  animation:spin .8s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
.loading p{font-size:14px;color:#888}
</style>
</head>
<body>

<div class="header">
  <h1>日本株データダッシュボード</h1>
  <div class="header-right">
    <input type="text" class="search-box" id="searchBox" placeholder="コード・銘柄検索...">
    <span class="count" id="stockCount"></span>
  </div>
</div>

<div class="loading" id="loading">
  <div class="spinner"></div>
  <p>データを読み込み中...</p>
</div>

<div class="table-wrap" id="tableWrap" style="display:none">
  <table>
    <thead><tr id="headRow"></tr></thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<div class="overlay" id="overlay">
  <div class="modal">
    <div class="modal-head">
      <h2 id="modalTitle"></h2>
      <button class="btn-close" id="btnClose">&times;</button>
    </div>
    <div class="chart-box">
      <canvas id="chartCanvas"></canvas>
    </div>
  </div>
</div>

<script>
/* ============================================================
   データ定義
   ============================================================ */
const COLS = [
  {key:'rank',    label:'#',                      sortable:false, chart:false, type:'rank'},
  {key:'code',    label:'銘柄コード',              sortable:true,  chart:false, type:'code'},
  {key:'name',    label:'銘柄名',                  sortable:true,  chart:false, type:'name'},
  {key:'price',   label:'株価',                    sortable:true,  chart:true,  color:'#1565c0', unit:'円', type:'price'},
  {key:'CurFYEn', label:'当事業年度終了日',         sortable:true,  chart:false, type:'date'},
  {key:'DiscDate',label:'開示日',                  sortable:true,  chart:false, type:'date'},
  {key:'NxtFYEn', label:'翌事業年度終了日',         sortable:true,  chart:false, type:'date'},
  {key:'Sales',   label:'売上高（当該年度・現時点）',          sortable:true,  chart:true,  color:'#1565c0', unit:'円', type:'bignum', quarterly:true, chartLabel:'四半期売上高（実績）'},
  {key:'OP',      label:'営業利益（当該年度・現時点）',        sortable:true,  chart:true,  color:'#2e7d32', unit:'円', type:'bignum', quarterly:true, chartLabel:'四半期営業利益（実績）'},
  {key:'OdP',     label:'経常利益（当該年度・現時点）',        sortable:true,  chart:true,  color:'#2e7d32', unit:'円', type:'bignum', quarterly:true, chartLabel:'四半期経常利益（実績）'},
  {key:'NP',      label:'当期純利益（当該年度・現時点）',      sortable:true,  chart:true,  color:'#2e7d32', unit:'百万円', type:'bignum', quarterly:true, chartLabel:'四半期当期純利益（実績）'},
  {key:'EPS',     label:'一株当たり当期純利益（当該年度・現時点）', sortable:true, chart:true, color:'#6a1b9a', unit:'円', type:'decimal', quarterly:true, chartLabel:'四半期一株当たり当期純利益（実績）'},
  {key:'DEPS',    label:'潜在株式調整後EPS',        sortable:true,  chart:true,  color:'#6a1b9a', unit:'円', type:'decimal'},
  {key:'TA',      label:'総資産',                  sortable:true,  chart:true,  color:'#e65100', unit:'円', type:'bignum'},
  {key:'Eq',      label:'純資産',                  sortable:true,  chart:true,  color:'#e65100', unit:'円', type:'bignum'},
  {key:'EqAR',    label:'自己資本比率',             sortable:true,  chart:true,  color:'#00838f', unit:'%', type:'percent'},
  {key:'BPS',     label:'一株あたり純資産',         sortable:true,  chart:true,  color:'#e65100', unit:'円', type:'decimal'},
  {key:'CFO',     label:'営業CF',                  sortable:true,  chart:true,  color:'#4527a0', unit:'円', type:'bignum'},
  {key:'CFI',     label:'投資CF',                  sortable:true,  chart:true,  color:'#4527a0', unit:'円', type:'bignum'},
  {key:'CFF',     label:'財務CF',                  sortable:true,  chart:true,  color:'#4527a0', unit:'円', type:'bignum'},
  {key:'CFTotal', label:'キャッシュフロー',         sortable:true,  chart:true,  color:'#283593', unit:'円', type:'bignum'},
  {key:'CashEq',  label:'現金同等物',              sortable:true,  chart:true,  color:'#4527a0', unit:'円', type:'bignum'},
  {key:'DivAnn',  label:'配当実績',                sortable:true,  chart:true,  color:'#c62828', unit:'円', type:'decimal'},
  {key:'FDivAnn', label:'配当予想',                sortable:true,  chart:true,  color:'#c62828', unit:'円', type:'decimal'},
  {key:'FPayoutRatioAnn', label:'予想配当性向',     sortable:true,  chart:true,  color:'#c62828', unit:'%', type:'percent'},
  {key:'FSales',  label:'売上高予想',              sortable:true,  chart:true,  color:'#1565c0', unit:'円', type:'bignum'},
  {key:'FOP',     label:'営業利益予想',            sortable:true,  chart:true,  color:'#2e7d32', unit:'円', type:'bignum'},
  {key:'FOdP',    label:'経常利益予想',            sortable:true,  chart:true,  color:'#2e7d32', unit:'円', type:'bignum'},
  {key:'FNP',     label:'純利益予想',              sortable:true,  chart:true,  color:'#2e7d32', unit:'円', type:'bignum'},
  {key:'FEPS',    label:'EPS予想',                 sortable:true,  chart:true,  color:'#6a1b9a', unit:'円', type:'decimal'},
  {key:'NxFSales',label:'売上高予想(翌)',           sortable:true,  chart:true,  color:'#1565c0', unit:'円', type:'bignum'},
  {key:'NxFOP',   label:'営業利益予想(翌)',         sortable:true,  chart:true,  color:'#2e7d32', unit:'円', type:'bignum'},
  {key:'NxFOdP',  label:'経常利益予想(翌)',         sortable:true,  chart:true,  color:'#2e7d32', unit:'円', type:'bignum'},
  {key:'NxFNp',   label:'純利益予想(翌)',           sortable:true,  chart:true,  color:'#2e7d32', unit:'円', type:'bignum'},
  {key:'NxFEPS',  label:'EPS予想(翌)',             sortable:true,  chart:true,  color:'#6a1b9a', unit:'円', type:'decimal'},
  {key:'DivYield',label:'配当利回り',               sortable:true,  chart:true,  color:'#c62828', unit:'%', type:'decimal'},
  {key:'FDivYield',label:'予想配当利回り',          sortable:true,  chart:true,  color:'#c62828', unit:'%', type:'decimal'},
  {key:'MarketCap',label:'時価総額',               sortable:true,  chart:true,  color:'#1565c0', unit:'円', type:'bignum'},
  {key:'per',     label:'PER',                    sortable:true,  chart:true,  color:'#6a1b9a', unit:'倍', type:'decimal'},
  {key:'fper',    label:'予想PER',                 sortable:true,  chart:true,  color:'#6a1b9a', unit:'倍', type:'decimal'},
  {key:'pbr',     label:'PBR',                    sortable:true,  chart:true,  color:'#e65100', unit:'倍', type:'decimal'},
  {key:'psr',     label:'PSR',                    sortable:true,  chart:true,  color:'#e65100', unit:'倍', type:'decimal'},
  {key:'roe',     label:'ROE',                    sortable:true,  chart:true,  color:'#00838f', unit:'%', type:'decimal'},
  {key:'roa',     label:'ROA',                    sortable:true,  chart:true,  color:'#00838f', unit:'%', type:'decimal'},
  {key:'ev_ebitda',label:'EV/EBITDA',              sortable:true,  chart:true,  color:'#4527a0', unit:'倍', type:'decimal'},
  {key:'pcfr',    label:'PCFR',                   sortable:true,  chart:true,  color:'#4527a0', unit:'倍', type:'decimal'},
];

// financeHistory index mapping
const FH = {
  NP:1, per:2, pbr:3, roe:4, pcfr:5, Sales:6, OP:7, OdP:8, EPS:9, BPS:10, CFO:11, CashEq:12, MarketCap:13, CurFYEn:14,
  TA:15, Eq:16, EqAR:17, CFI:18, CFF:19, DivAnn:20, DEPS:21, roa:22, DivYield:23, fper:24, psr:25, ev_ebitda:26,
  FDivAnn:27, FPayoutRatioAnn:28, FSales:29, FOP:30, FOdP:31, FNP:32, FEPS:33,
  NxFSales:34, NxFOP:35, NxFOdP:36, NxFNp:37, NxFEPS:38, FDivYield:39, CFTotal:40,
};

let allStocks = [];   // 全データ
let viewStocks = [];  // フィルタ後
let sortKey = null;
let sortAsc = true;
let chartInstance = null;

/* ============================================================
   初期化
   ============================================================ */
document.addEventListener('DOMContentLoaded', init);

async function init() {
  buildHeader();

  try {
    const res = await fetch('stock_data.json');
    allStocks = await res.json();
  } catch (e) {
    document.getElementById('loading').innerHTML =
      '<p style="color:#c00">stock_data.json の読み込みに失敗しました。<br>python3 build_data.py を実行してデータを生成してください。<br>また python3 -m http.server でサーバーを起動してアクセスしてください。</p>';
    return;
  }

  viewStocks = allStocks.slice();
  sortBy('code', true);

  document.getElementById('loading').style.display = 'none';
  document.getElementById('tableWrap').style.display = '';
  updateCount();

  // イベント
  document.getElementById('searchBox').addEventListener('input', onSearch);
  document.getElementById('overlay').addEventListener('click', e => {
    if (e.target.id === 'overlay') closeModal();
  });
  document.getElementById('btnClose').addEventListener('click', closeModal);
  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
}

/* ============================================================
   ヘッダー構築
   ============================================================ */
function buildHeader() {
  const tr = document.getElementById('headRow');
  COLS.forEach(col => {
    const th = document.createElement('th');
    th.textContent = col.label;
    if (col.type === 'code' || col.type === 'name') th.style.textAlign = 'left';
    if (col.sortable) {
      th.dataset.key = col.key;
      th.addEventListener('click', () => onHeaderClick(col.key));
      const span = document.createElement('span');
      span.className = 'sort-icon';
      span.id = 'sort-' + col.key;
      th.appendChild(span);
    }
    tr.appendChild(th);
  });
}

/* ============================================================
   テーブル描画
   ============================================================ */
function renderTable() {
  const tbody = document.getElementById('tbody');
  const fragment = document.createDocumentFragment();

  viewStocks.forEach((s, i) => {
    const tr = document.createElement('tr');

    COLS.forEach(col => {
      const td = document.createElement('td');
      const val = s[col.key];

      switch (col.type) {
        case 'rank':
          td.textContent = i + 1;
          break;
        case 'code':
          td.textContent = s.code;
          td.className = 'col-code';
          break;
        case 'name':
          td.textContent = s.name || s.code;
          td.className = 'col-name';
          td.title = s.name || s.code;
          break;
        case 'price':
          td.textContent = val != null ? formatNum(val) : '-';
          break;
        case 'date':
          td.textContent = val || '-';
          td.className = 'col-date';
          break;
        case 'bignum':
          if (val != null) {
            td.textContent = formatBigNum(val);
            if (val < 0) td.className = 'negative';
          } else {
            td.textContent = '-';
          }
          break;
        case 'percent':
          if (val != null) {
            td.textContent = formatDec(val * 100) + '%';
            if (val < 0) td.className = 'negative';
          } else {
            td.textContent = '-';
          }
          break;
        case 'decimal':
        default:
          if (val != null) {
            td.textContent = formatDec(val);
            if (val < 0) td.className = 'negative';
          } else {
            td.textContent = '-';
          }
          break;
      }

      // クリックでチャート表示
      if (col.chart) {
        td.addEventListener('click', () => showChart(s, col.key));
      }

      tr.appendChild(td);
    });

    fragment.appendChild(tr);
  });

  tbody.innerHTML = '';
  tbody.appendChild(fragment);
}

/* ============================================================
   ソート
   ============================================================ */
function onHeaderClick(key) {
  if (sortKey === key) {
    sortAsc = !sortAsc;
  } else {
    sortAsc = (key === 'code' || key === 'name');
  }
  sortBy(key, sortAsc);
}

function sortBy(key, asc) {
  sortKey = key;
  sortAsc = asc;

  viewStocks.sort((a, b) => {
    let va = a[key];
    let vb = b[key];
    // null は最後
    if (va == null && vb == null) return 0;
    if (va == null) return 1;
    if (vb == null) return -1;
    if (typeof va === 'string') {
      return asc ? va.localeCompare(vb) : vb.localeCompare(va);
    }
    return asc ? va - vb : vb - va;
  });

  updateSortIcons();
  renderTable();
}

function updateSortIcons() {
  COLS.forEach(col => {
    if (!col.sortable) return;
    const el = document.getElementById('sort-' + col.key);
    if (col.key === sortKey) {
      el.textContent = sortAsc ? ' \u25B2' : ' \u25BC';
    } else {
      el.textContent = '';
    }
  });
}

/* ============================================================
   検索フィルタ
   ============================================================ */
function onSearch() {
  const q = document.getElementById('searchBox').value.trim().toLowerCase();
  if (!q) {
    viewStocks = allStocks.slice();
  } else {
    viewStocks = allStocks.filter(s =>
      s.code.toLowerCase().includes(q) || (s.name && s.name.toLowerCase().includes(q))
    );
  }
  if (sortKey) sortBy(sortKey, sortAsc);
  else renderTable();
  updateCount();
}

function updateCount() {
  document.getElementById('stockCount').textContent =
    viewStocks.length + ' / ' + allStocks.length + ' 銘柄';
}

/* ============================================================
   チャート表示
   ============================================================ */
function showChart(stock, colKey) {
  const colDef = COLS.find(c => c.key === colKey);
  if (!colDef || !colDef.chart) return;

  let labels, values, title, unit, bgColor;
  unit = colDef.unit;
  bgColor = colDef.color;
  if (colDef.quarterly) {
    // 四半期別表示（累積値→四半期ごとに変換）
    title = stock.code + ' ' + (stock.name || '') + ' - ' + colDef.chartLabel;
    const result = computeQuarterlyData(stock, colKey);
    labels = result.labels;
    values = result.values;
    if (['NP','Sales','OP','OdP'].includes(colKey)) unit = '億円';
  } else if (colKey === 'price') {
    title = stock.code + ' ' + (stock.name || '') + ' - ' + colDef.label;
    // 月次株価データ
    const ph = stock.ph || [];
    labels = ph.map(p => p[0]);
    values = ph.map(p => p[1]);
  } else {
    title = stock.code + ' ' + (stock.name || '') + ' - ' + colDef.label;
    // 財務データ履歴
    const fh = stock.fh || [];
    const idx = FH[colKey];
    if (idx == null) return;

    // nullでないデータのみ
    const filtered = fh.filter(row => row[idx] != null);
    labels = filtered.map(row => row[0]);

    const bignumKeys = ['NP','Sales','OP','OdP','TA','Eq','CFI','CFF','CFTotal','CashEq','CFO','MarketCap',
                        'FSales','FOP','FOdP','FNP','NxFSales','NxFOP','NxFOdP','NxFNp'];
    if (bignumKeys.includes(colKey)) {
      values = filtered.map(row => Math.round(row[idx] / 10000000) / 10);
      unit = '億円';
    } else if (colDef.type === 'percent') {
      // EqAR, FPayoutRatioAnn等: fhには生の値（0-1の比率）→%に変換
      values = filtered.map(row => Math.round(row[idx] * 10000) / 100);
      unit = '%';
    } else {
      values = filtered.map(row => row[idx]);
    }
  }

  if (!labels.length) {
    alert('この銘柄の' + colDef.label + 'の過去データがありません。');
    return;
  }

  // チャート色（負の値は赤）
  const bgColors = values.map(v =>
    v < 0 ? 'rgba(211,47,47,0.7)' : hexToRGBA(bgColor, 0.7)
  );
  const borderColors = values.map(v =>
    v < 0 ? 'rgba(211,47,47,1)' : bgColor
  );

  document.getElementById('modalTitle').innerHTML =
    title + '<span class="sub">' + unit + '</span>';

  // 既存チャート破棄
  if (chartInstance) {
    chartInstance.destroy();
    chartInstance = null;
  }

  const ctx = document.getElementById('chartCanvas').getContext('2d');
  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: colDef.chartLabel || colDef.label,
        data: values,
        backgroundColor: bgColors,
        borderColor: borderColors,
        borderWidth: 1,
        borderRadius: 2,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {display: false},
        tooltip: {
          callbacks: {
            label: ctx => (colDef.chartLabel || colDef.label) + ': ' + formatNum(ctx.parsed.y) + ' ' + unit
          }
        }
      },
      scales: {
        x: {
          ticks: {
            maxRotation: 60,
            autoSkip: true,
            maxTicksLimit: 30,
            font: {size: 10}
          },
          grid: {display: false}
        },
        y: {
          ticks: {
            callback: v => formatCompact(v),
            font: {size: 11}
          },
          grid: {color: 'rgba(0,0,0,.06)'}
        }
      },
      animation: {duration: 400}
    }
  });

  document.getElementById('overlay').classList.add('active');
}

/* ============================================================
   四半期データ変換（累積値→四半期ごと）
   ============================================================ */
function computeQuarterlyData(stock, colKey) {
  const fh = stock.fh || [];
  const idx = FH[colKey];
  const fyIdx = FH.CurFYEn;

  // CurFYEnでグループ化
  const fyGroups = {};
  for (const row of fh) {
    const fy = row[fyIdx];
    const val = row[idx];
    if (!fy || val == null) continue;
    if (!fyGroups[fy]) fyGroups[fy] = [];
    fyGroups[fy].push({date: row[0], value: val});
  }

  const labels = [];
  const values = [];

  // 事業年度でソート
  const sortedFYs = Object.keys(fyGroups).sort();

  for (const fy of sortedFYs) {
    const entries = fyGroups[fy];
    // 開示日でソート
    entries.sort((a, b) => a.date.localeCompare(b.date));

    // CurFYEnからFY表示用ラベルを生成（例: "2022-03-31" → "FY2021"）
    const fyYear = fy.substring(0, 4);
    const fyMonth = parseInt(fy.substring(5, 7));
    // 事業年度の開始年: 決算月が1-3月なら前年度開始
    const startYear = fyMonth <= 3 ? parseInt(fyYear) - 1 : parseInt(fyYear);

    // 累積値→四半期値に変換（最大4四半期）
    let prevCumulative = 0;
    const maxQ = Math.min(entries.length, 4);
    for (let i = 0; i < maxQ; i++) {
      const qNum = i + 1;
      const qValue = entries[i].value - prevCumulative;
      prevCumulative = entries[i].value;

      labels.push(startYear + 'Q' + qNum);

      // 億円単位に変換（EPS以外）
      if (colKey === 'EPS') {
        values.push(Math.round(qValue * 100) / 100);
      } else {
        values.push(Math.round(qValue / 10000000) / 10);
      }
    }
  }

  return {labels, values};
}

function closeModal() {
  document.getElementById('overlay').classList.remove('active');
  if (chartInstance) {
    chartInstance.destroy();
    chartInstance = null;
  }
}

/* ============================================================
   ユーティリティ
   ============================================================ */
function formatNum(n) {
  if (n == null) return '-';
  return Number(n).toLocaleString('ja-JP');
}

function formatDec(n) {
  if (n == null) return '-';
  return Number(n).toLocaleString('ja-JP', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
}

function formatBigNum(n) {
  if (n == null) return '-';
  // 億単位で表示
  const oku = n / 100000000;
  if (Math.abs(oku) >= 1) {
    return oku.toLocaleString('ja-JP', {
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }) + '億';
  }
  // 百万単位
  const hyakuman = n / 1000000;
  if (Math.abs(hyakuman) >= 1) {
    return hyakuman.toLocaleString('ja-JP', {
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }) + '百万';
  }
  return formatNum(n);
}

function formatCompact(n) {
  if (Math.abs(n) >= 1e8) return (n / 1e8).toFixed(1) + '億';
  if (Math.abs(n) >= 1e4) return (n / 1e4).toFixed(1) + '万';
  return n.toLocaleString('ja-JP');
}

function hexToRGBA(hex, alpha) {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  return 'rgba(' + r + ',' + g + ',' + b + ',' + alpha + ')';
}
</script>
</body>
</html>
