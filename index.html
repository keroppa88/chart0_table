<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>日本株データダッシュボード</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:'Segoe UI','Hiragino Kaku Gothic Pro','Yu Gothic',sans-serif;
  background:#f0f2f5;
  color:#1a1a2e;
}

/* ===== ヘッダー ===== */
.header{
  background:linear-gradient(135deg,#1a237e 0%,#283593 100%);
  color:#fff;
  padding:14px 24px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  position:sticky;top:0;z-index:50;
  box-shadow:0 2px 8px rgba(0,0,0,.25);
}
.header h1{font-size:18px;font-weight:600;letter-spacing:.5px}
.header-right{display:flex;align-items:center;gap:16px;font-size:13px}
.header-right .count{opacity:.85}
.search-box{
  padding:6px 12px;
  border:none;border-radius:6px;
  background:rgba(255,255,255,.15);
  color:#fff;
  font-size:13px;
  width:200px;
  outline:none;
}
.search-box::placeholder{color:rgba(255,255,255,.5)}
.search-box:focus{background:rgba(255,255,255,.25)}

/* ===== テーブル ===== */
.table-wrap{
  overflow:auto;
  max-height:calc(100vh - 52px);
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
  table-layout:fixed;
}
colgroup col.col-rank{width:56px}
colgroup col.col-code{width:80px}
colgroup col.col-name{width:80px}
colgroup col.col-price{width:100px}
colgroup col.col-profit{width:120px}
colgroup col.col-num{width:90px}

thead{position:sticky;top:0;z-index:10}
th{
  background:#303f9f;
  color:#fff;
  padding:10px 10px;
  text-align:right;
  cursor:pointer;
  white-space:nowrap;
  user-select:none;
  border-right:1px solid rgba(255,255,255,.08);
  font-weight:600;
  font-size:12px;
  letter-spacing:.3px;
}
th:first-child{text-align:center}
th:hover{background:#3949ab}
th .sort-icon{font-size:10px;margin-left:3px;opacity:.7}

td{
  padding:7px 10px;
  text-align:right;
  border-bottom:1px solid #e8eaf0;
  cursor:pointer;
  white-space:nowrap;
  transition:background .1s;
}
td:first-child{text-align:center;color:#888;font-size:12px}
td.col-code{text-align:left;font-weight:600;color:#1a237e}
td.col-name{text-align:left;font-size:12px}

tr:nth-child(even) td{background:#f8f9fc}
tr:hover td{background:#e3f2fd}
td:hover{background:#bbdefb !important}

.negative{color:#d32f2f}

/* ===== モーダル ===== */
.overlay{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  z-index:200;
  justify-content:center;
  align-items:center;
  backdrop-filter:blur(2px);
}
.overlay.active{display:flex}

.modal{
  background:#fff;
  border-radius:14px;
  padding:24px 28px;
  width:92vw;max-width:860px;
  max-height:92vh;overflow:auto;
  box-shadow:0 24px 64px rgba(0,0,0,.3);
}
.modal-head{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:16px;
}
.modal-head h2{font-size:16px;color:#1a237e}
.modal-head .sub{font-size:13px;color:#666;margin-left:12px;font-weight:400}
.btn-close{
  background:none;border:none;
  font-size:26px;cursor:pointer;
  color:#999;line-height:1;
  padding:0 4px;
}
.btn-close:hover{color:#333}

.chart-box{position:relative;height:400px}

/* ===== ローディング ===== */
.loading{
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  height:80vh;
  gap:12px;
}
.loading .spinner{
  width:36px;height:36px;
  border:3px solid #e0e0e0;
  border-top-color:#1a237e;
  border-radius:50%;
  animation:spin .8s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
.loading p{font-size:14px;color:#888}
</style>
</head>
<body>

<div class="header">
  <h1>日本株データダッシュボード</h1>
  <div class="header-right">
    <input type="text" class="search-box" id="searchBox" placeholder="コード・銘柄検索...">
    <span class="count" id="stockCount"></span>
  </div>
</div>

<div class="loading" id="loading">
  <div class="spinner"></div>
  <p>データを読み込み中...</p>
</div>

<div class="table-wrap" id="tableWrap" style="display:none">
  <table>
    <colgroup>
      <col class="col-rank">
      <col class="col-code">
      <col class="col-name">
      <col class="col-price">
      <col class="col-profit">
      <col class="col-num">
      <col class="col-num">
      <col class="col-num">
      <col class="col-num">
    </colgroup>
    <thead><tr id="headRow"></tr></thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<div class="overlay" id="overlay">
  <div class="modal">
    <div class="modal-head">
      <h2 id="modalTitle"></h2>
      <button class="btn-close" id="btnClose">&times;</button>
    </div>
    <div class="chart-box">
      <canvas id="chartCanvas"></canvas>
    </div>
  </div>
</div>

<script>
/* ============================================================
   データ定義
   ============================================================ */
const COLS = [
  {key:'rank',  label:'#',          sortable:false, chart:false},
  {key:'code',  label:'コード',     sortable:true,  chart:false, align:'left'},
  {key:'name',  label:'銘柄名',     sortable:true,  chart:false, align:'left'},
  {key:'price', label:'株価',       sortable:true,  chart:true,  color:'#1565c0', unit:'円'},
  {key:'profit',label:'利益',       sortable:true,  chart:true,  color:'#2e7d32', unit:'百万円'},
  {key:'per',   label:'PER',       sortable:true,  chart:true,  color:'#6a1b9a', unit:'倍'},
  {key:'pbr',   label:'PBR',       sortable:true,  chart:true,  color:'#e65100', unit:'倍'},
  {key:'roe',   label:'ROE',       sortable:true,  chart:true,  color:'#00838f', unit:'%'},
  {key:'pcfr',  label:'PCFR',      sortable:true,  chart:true,  color:'#4527a0', unit:'倍'},
];

// financeHistory index mapping: [date, profit, per, pbr, roe, pcfr]
const FH = {profit:1, per:2, pbr:3, roe:4, pcfr:5};

let allStocks = [];   // 全データ
let viewStocks = [];  // フィルタ後
let sortKey = null;
let sortAsc = true;
let chartInstance = null;

/* ============================================================
   初期化
   ============================================================ */
document.addEventListener('DOMContentLoaded', init);

async function init() {
  buildHeader();

  try {
    const res = await fetch('stock_data.json');
    allStocks = await res.json();
  } catch (e) {
    document.getElementById('loading').innerHTML =
      '<p style="color:#c00">stock_data.json の読み込みに失敗しました。<br>python3 build_data.py を実行してデータを生成してください。<br>また python3 -m http.server でサーバーを起動してアクセスしてください。</p>';
    return;
  }

  // 銘柄名はデータに含まれないためコードで代替
  allStocks.forEach(s => { s.name = s.code; });

  viewStocks = allStocks.slice();
  sortBy('code', true);

  document.getElementById('loading').style.display = 'none';
  document.getElementById('tableWrap').style.display = '';
  updateCount();

  // イベント
  document.getElementById('searchBox').addEventListener('input', onSearch);
  document.getElementById('overlay').addEventListener('click', e => {
    if (e.target.id === 'overlay') closeModal();
  });
  document.getElementById('btnClose').addEventListener('click', closeModal);
  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
}

/* ============================================================
   ヘッダー構築
   ============================================================ */
function buildHeader() {
  const tr = document.getElementById('headRow');
  COLS.forEach(col => {
    const th = document.createElement('th');
    th.textContent = col.label;
    if (col.align === 'left') th.style.textAlign = 'left';
    if (col.sortable) {
      th.dataset.key = col.key;
      th.addEventListener('click', () => onHeaderClick(col.key));
      const span = document.createElement('span');
      span.className = 'sort-icon';
      span.id = 'sort-' + col.key;
      th.appendChild(span);
    }
    tr.appendChild(th);
  });
}

/* ============================================================
   テーブル描画
   ============================================================ */
function renderTable() {
  const tbody = document.getElementById('tbody');
  // 仮想DOM的に一括挿入
  const fragment = document.createDocumentFragment();

  viewStocks.forEach((s, i) => {
    const tr = document.createElement('tr');

    COLS.forEach((col, ci) => {
      const td = document.createElement('td');

      if (col.key === 'rank') {
        td.textContent = i + 1;
      } else if (col.key === 'code') {
        td.textContent = s.code;
        td.className = 'col-code';
      } else if (col.key === 'name') {
        td.textContent = s.name;
        td.className = 'col-name';
      } else if (col.key === 'price') {
        td.textContent = s.price != null ? formatNum(s.price) : '-';
      } else if (col.key === 'profit') {
        const val = s.profit != null ? Math.round(s.profit / 1000000) : null;
        td.textContent = val != null ? formatNum(val) : '-';
        if (val != null && val < 0) td.className = 'negative';
      } else {
        const v = s[col.key];
        td.textContent = v != null ? formatDec(v) : '-';
        if (v != null && v < 0) td.className = 'negative';
      }

      // クリックでチャート表示
      if (col.chart) {
        td.addEventListener('click', () => showChart(s, col.key));
      }

      tr.appendChild(td);
    });

    fragment.appendChild(tr);
  });

  tbody.innerHTML = '';
  tbody.appendChild(fragment);
}

/* ============================================================
   ソート
   ============================================================ */
function onHeaderClick(key) {
  if (sortKey === key) {
    sortAsc = !sortAsc;
  } else {
    sortAsc = (key === 'code' || key === 'name');
  }
  sortBy(key, sortAsc);
}

function sortBy(key, asc) {
  sortKey = key;
  sortAsc = asc;

  viewStocks.sort((a, b) => {
    let va = getSortVal(a, key);
    let vb = getSortVal(b, key);
    // null は最後
    if (va == null && vb == null) return 0;
    if (va == null) return 1;
    if (vb == null) return -1;
    if (typeof va === 'string') {
      return asc ? va.localeCompare(vb) : vb.localeCompare(va);
    }
    return asc ? va - vb : vb - va;
  });

  updateSortIcons();
  renderTable();
}

function getSortVal(stock, key) {
  if (key === 'profit') {
    return stock.profit != null ? stock.profit : null;
  }
  return stock[key] != null ? stock[key] : null;
}

function updateSortIcons() {
  COLS.forEach(col => {
    if (!col.sortable) return;
    const el = document.getElementById('sort-' + col.key);
    if (col.key === sortKey) {
      el.textContent = sortAsc ? ' \u25B2' : ' \u25BC';
    } else {
      el.textContent = '';
    }
  });
}

/* ============================================================
   検索フィルタ
   ============================================================ */
function onSearch() {
  const q = document.getElementById('searchBox').value.trim().toLowerCase();
  if (!q) {
    viewStocks = allStocks.slice();
  } else {
    viewStocks = allStocks.filter(s =>
      s.code.toLowerCase().includes(q) || s.name.toLowerCase().includes(q)
    );
  }
  if (sortKey) sortBy(sortKey, sortAsc);
  else renderTable();
  updateCount();
}

function updateCount() {
  document.getElementById('stockCount').textContent =
    viewStocks.length + ' / ' + allStocks.length + ' 銘柄';
}

/* ============================================================
   チャート表示
   ============================================================ */
function showChart(stock, colKey) {
  const colDef = COLS.find(c => c.key === colKey);
  if (!colDef || !colDef.chart) return;

  let labels, values, title, unit, bgColor;
  unit = colDef.unit;
  bgColor = colDef.color;
  title = stock.code + ' - ' + colDef.label;

  if (colKey === 'price') {
    // 月次株価データ
    const ph = stock.ph || [];
    labels = ph.map(p => p[0]);
    values = ph.map(p => p[1]);
  } else {
    // 財務データ履歴
    const fh = stock.fh || [];
    const idx = FH[colKey];
    if (idx == null) return;

    // nullでないデータのみ
    const filtered = fh.filter(row => row[idx] != null);
    labels = filtered.map(row => row[0]);

    if (colKey === 'profit') {
      values = filtered.map(row => Math.round(row[idx] / 1000000));
    } else {
      values = filtered.map(row => row[idx]);
    }
  }

  if (!labels.length) {
    alert('この銘柄の' + colDef.label + 'の過去データがありません。');
    return;
  }

  // チャート色（負の値は赤）
  const bgColors = values.map(v =>
    v < 0 ? 'rgba(211,47,47,0.7)' : hexToRGBA(bgColor, 0.7)
  );
  const borderColors = values.map(v =>
    v < 0 ? 'rgba(211,47,47,1)' : bgColor
  );

  document.getElementById('modalTitle').innerHTML =
    title + '<span class="sub">' + unit + '</span>';

  // 既存チャート破棄
  if (chartInstance) {
    chartInstance.destroy();
    chartInstance = null;
  }

  const ctx = document.getElementById('chartCanvas').getContext('2d');
  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: colDef.label,
        data: values,
        backgroundColor: bgColors,
        borderColor: borderColors,
        borderWidth: 1,
        borderRadius: 2,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {display: false},
        tooltip: {
          callbacks: {
            label: ctx => colDef.label + ': ' + formatNum(ctx.parsed.y) + ' ' + unit
          }
        }
      },
      scales: {
        x: {
          ticks: {
            maxRotation: 60,
            autoSkip: true,
            maxTicksLimit: 30,
            font: {size: 10}
          },
          grid: {display: false}
        },
        y: {
          ticks: {
            callback: v => formatCompact(v),
            font: {size: 11}
          },
          grid: {color: 'rgba(0,0,0,.06)'}
        }
      },
      animation: {duration: 400}
    }
  });

  document.getElementById('overlay').classList.add('active');
}

function closeModal() {
  document.getElementById('overlay').classList.remove('active');
  if (chartInstance) {
    chartInstance.destroy();
    chartInstance = null;
  }
}

/* ============================================================
   ユーティリティ
   ============================================================ */
function formatNum(n) {
  if (n == null) return '-';
  return Number(n).toLocaleString('ja-JP');
}

function formatDec(n) {
  if (n == null) return '-';
  return Number(n).toLocaleString('ja-JP', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
}

function formatCompact(n) {
  if (Math.abs(n) >= 1e9) return (n / 1e9).toFixed(1) + 'B';
  if (Math.abs(n) >= 1e6) return (n / 1e6).toFixed(1) + 'M';
  if (Math.abs(n) >= 1e3) return (n / 1e3).toFixed(1) + 'K';
  return n.toLocaleString('ja-JP');
}

function hexToRGBA(hex, alpha) {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  return 'rgba(' + r + ',' + g + ',' + b + ',' + alpha + ')';
}
</script>
</body>
</html>
